# Face Fruit Eater（张嘴吃水果）详细设计文档

## 1. 项目目标

- 项目类型：浏览器端 AI 体感小游戏（单局 2-5 分钟）。
- 核心卖点：通过摄像头识别“嘴部开合 + 头部位置”完成抓取，不依赖键鼠。
- 设计目标：
  - 15 秒内理解玩法并开始游戏。
  - 60 秒内出现至少 2 次高刺激事件（如连击、危机、反转道具）。
  - 单局保持“高风险高回报”节奏，避免纯随机和无脑刷分。

## 2. 目标用户与场景

- 目标用户：
  - 休闲玩家、短视频创作者、线下活动互动屏用户。
- 典型场景：
  - PC 摄像头试玩。
  - 投屏到电视/大屏进行多人同乐（当前支持最多 2 张脸）。

## 3. 游戏核心循环（Core Loop）

1. 摄像头识别人脸，实时计算嘴部开合状态。
2. 食物/陷阱从上方生成并下落。
3. 玩家将嘴部判定圈移动到道具位置。
4. 张嘴时触发“吃到”判定并结算得分/状态。
5. 能量持续衰减，玩家必须不断进食维持生存。
6. 通过连击、道具和状态管理追求更高分数。

## 4. 当前实现映射（依据 `1.html`）

### 4.1 输入与识别

- AI：MediaPipe Tasks Vision (`@mediapipe/tasks-vision@0.10.0`)。
- 模型：`face_landmarker.task`。
- 人脸数：`numFaces: 2`。
- 嘴部判定：
  - 取 landmark 13 与 14 计算嘴高。
  - 取 landmark 10 与 152 计算脸高。
  - `openRatio = mouthHeight / faceHeight`。
  - 判定阈值：`openRatio > 0.05`。

### 4.2 生存与难度

- HP 初始值：`100`。
- 饥饿衰减：`0.1 + level * 0.02 / 帧`。
- 升级条件：`level = 1 + floor(score / 1500)`。
- 生成节奏：`spawnRate = max(5, 50 - level * 3)`（帧）。
- 风系统：每 300 帧判定一次，有 40% 概率出现左右风，持续约 60 帧。

### 4.3 分数与连击

- 基础分来自 `item.score`。
- 正收益触发连击：
  - `comboCount += 1`
  - 额外加成：`min(comboCount * 5, 50)`。
- 负收益会打断连击（`comboCount = 0`）。
- Party 模式下得分翻倍（当前逻辑中计时器存在但触发来源待补）。

### 4.4 状态系统

- 全局状态：`slow`、`mask`、`rush`、`shield`、`windChange` 等。
- 玩家状态：`silence`（嘴肿）、`pepper`（辣椒散热）、`sour`（酸僵直）。
- 视觉反馈：critical/toothache/sour/rush/party 等 CSS 模式叠加。

## 5. 道具与事件设计（现状 + 规范化建议）

## 5.1 分类定义

- `healthy`：健康食物，倾向稳态回血与减脂。
- `junk`：高分但副作用大（糖分/肥胖）。
- `trap`：直接伤害或负面状态。
- `buff`：功能型增益，提供逆风翻盘。

## 5.2 现有道具表（代码可见）

- 健康类：`🍎🥦🥒`。
- 垃圾类：`🍔🍩🍬`。
- 陷阱类：`💣💩🧟🐝`。
- 增益类：`💧☕🪥🍋🕒🌶️🎭🌟`。

## 5.3 需要修正的配置一致性问题

当前 `1.html` 存在以下可维护性问题，建议在下一轮迭代优先修复：

- `spawnItem` 中存在 `if (i.type === 'food')`，但配置主要使用 `healthy/junk`，会导致权重逻辑与意图不一致。
- `playSound('party')`、`playSound('pain')` 在音效函数中未定义分支。
- 分支中出现 `shield/mystery/lobster/icecream/donut/candy` 等未在配置表统一定义的标识。
- `slow-mode` 样式被使用但 CSS 中未定义。

建议先做“配置单一真相源（Single Source of Truth）”：
- 所有道具 ID、类型、权重、音效 key 在同一配置表维护。
- 运行前进行配置校验，发现未定义 key 直接告警。

## 6. 数值体验设计（建议版）

- 目标单局时长：3 分钟。
- 建议节奏：
  - 0-45 秒：教学期，陷阱权重低，鼓励建立正反馈。
  - 45-120 秒：决策期，垃圾食物高分诱惑与状态管理并行。
  - 120 秒后：生存期，风/陷阱/状态重叠，强调操作与应急道具。
- 建议限制：
  - 糖分满槽后，不仅扣分，还应降低张嘴判定窗口（提高挑战辨识度）。
  - 肥胖/消瘦应影响“横向判定范围”而不是纯半径，避免体验偏差过大。

## 7. UI/UX 详细设计

- 主 HUD：`得分 + 等级 + HP + 糖分 + 体型平衡 + 连击`。
- 战斗提示：屏幕中央短提示（2 秒），只显示最高优先级状态。
- 暂停系统：支持按钮 + Space 键，暂停后冻结逻辑帧。
- 新手引导（首局）：
  - Step1：移动脸让圈圈碰到食物。
  - Step2：张嘴吃，闭嘴不吃。
  - Step3：别吃陷阱，先保命再冲分。

## 8. 技术架构重构建议（从单文件到工程化）

建议目录：

```txt
src/
  core/
    gameLoop.ts
    state.ts
    events.ts
  ai/
    faceTracker.ts
    mouthDetector.ts
  gameplay/
    itemSystem.ts
    collision.ts
    effects.ts
    balanceSystem.ts
  ui/
    hud.ts
    overlays.ts
  config/
    items.ts
    tuning.ts
  assets/
    sounds/
```

拆分原则：

- “渲染”和“规则”解耦：逻辑层不直接操作 DOM。
- 规则数据化：权重、持续时间、伤害系数放在 `tuning.ts`。
- 引入轻量事件总线：吃到道具后广播事件，UI/音效/特效各自订阅。

## 9. 测试与验收标准

## 9.1 功能验收

- 摄像头授权失败时，能显示错误并允许重试。
- 2 人同屏时，互不串状态。
- 10 分钟持续运行，无明显内存上涨或帧率崩溃。

## 9.2 玩法验收

- 新玩家首局平均时长 >= 90 秒。
- 首局能在 30 秒内触发至少一次正向高潮反馈（连击或高分道具）。
- 陷阱命中后反馈明确（音效、视觉、分数变化三者至少两者同时出现）。

## 10. 迭代里程碑（建议）

1. M1（可玩稳定版）
- 修复配置不一致问题。
- 抽离配置表和判定逻辑。
- 增加错误处理与性能监控面板。

2. M2（内容增强版）
- 新增 8-12 个道具与组合效果。
- 引入每日挑战（如“禁吃甜食”）。
- 增加战后结算页（命中率、连击峰值、危险回避率）。

3. M3（传播版）
- 录屏/回放短片导出。
- 全局排行榜（可匿名）。
- 主题皮肤（万圣节/春节）。

## 11. 当前项目建议的下一步开发清单

- 先做“配置一致性修复”和“模块化拆分”，再扩内容。
- 补齐缺失音效 key 与样式 key，避免运行期分支失效。
- 将状态持续时间和权重全部参数化，便于后续调平衡。
- 增加开发者调试面板：实时显示嘴部开合值、判定阈值、FPS。

